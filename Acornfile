profiles: {
    dev: {
        ingressControllerNamespace: "kube-system"
        allowTrafficFromNamespaces: "datadog-agent,prometheus-operator,prometheus,monitoring"
        local: "true"
    }
}

args: {
    // The namespace where the ingress controller is installed
    ingressControllerNamespace: "traefik"
    // List of namespaces that must send traffic to all Acorn apps (comma separated)
    allowTrafficFromNamespaces: ""
    // Set to "true" if running in a local cluster
    local: "false"
}

containers: "istio-plugin-controller": {
	build: "."
	env: IMAGE: "${secret://image/image}"
	command: ["--debug-image", "$(IMAGE)", "--ingress-controller-namespace", args.ingressControllerNamespace, "--allow-traffic-from-namespaces", args.allowTrafficFromNamespaces, "--local=\(args.local)"]
	permissions: clusterRules: [
		{
			verbs: ["list", "get", "patch", "update", "watch"]
			apiGroups: [""]
			resources: ["namespaces"]
		},
		{
			verbs: ["get", "create", "update"]
			apiGroups: ["coordination.k8s.io"]
			resources: ["leases"]
		},
		{
			verbs: ["*"]
			apiGroups: [""]
			resources: ["pods"]
		},
		{
			verbs: ["patch", "update"]
			apiGroups: [""]
			resources: ["pods/ephemeralcontainers"]
		},
		{
			verbs: ["*"]
			apiGroups: ["security.istio.io"]
			resources: ["peerauthentications", "authorizationpolicies"]
		},
		{
		    verbs: ["list", "get", "watch"]
		    apiGroups: ["networking.k8s.io"]
		    resources: ["ingresses"]
		},
		{
		    verbs: ["list", "get", "watch"]
		    apiGroups: [""]
		    resources: ["services"]
		},
		{
		    verbs: ["list", "get"]
		    apiGroups: [""]
		    resources: ["nodes"]
		}
	]
}

secrets: image: {
	type: "template"
	data: image: "${image://debug}"
}

images: debug: build: "."
